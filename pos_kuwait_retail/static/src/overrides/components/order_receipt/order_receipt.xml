<?xml version="1.0" encoding="utf-8"?>
<templates id="template" xml:space="preserve">
    <t t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('pos-receipt')]" position="replace">
            <div class="pos-receipt">

                <!-- HEADER -->
                <div class="receipt-section text-center">
                    <img t-attf-src="/web/image?model=res.company&amp;id={{props.data.headerData.company.id}}&amp;field=logo"
                         alt="Logo" class="w-100 mb-1"/>

                    <!-- Company Info -->
                    <div class="company-info">
                        <t t-if="props.data.headerData.company.street">
                            <div><t t-esc="props.data.headerData.company.street"/></div>
                        </t>
                        <t t-if="props.data.headerData.company.street2">
                            <div><t t-esc="props.data.headerData.company.street2"/></div>
                        </t>
                        <div t-if="props.data.headerData.company.city">
                            <t t-esc="props.data.headerData.company.city"/>
                            <t t-if="props.data.headerData.company.zip"> <t t-esc="props.data.headerData.company.zip"/></t>
                        </div>
                        <div t-if="props.data.headerData.company.phone" t-esc="props.data.headerData.company.phone"/>
                        <div t-if="props.data.headerData.company.mobile" t-esc="props.data.headerData.company.mobile"/>
                        <div t-if="props.data.headerData.company.email" t-esc="props.data.headerData.company.email"/>
                    </div>

                    <div t-if="props.data.headerData.header" class="mt-1" t-esc="props.data.headerData.header"/>
                </div>

                <!-- ORDER INFO -->
                <div class="receipt-section border-top border-bottom border-dark">
                    <div t-if="props.data.name"><t t-esc="props.data.name"/></div>
                    <div t-if="props.data.invoice_reference">Invoice Ref: <t t-esc="props.data.invoice_reference"/></div>
                    <div t-if="props.data.sales_person">Sales person: <t t-esc="props.data.sales_person"/></div>
                    <div t-if="props.data.date">Date: <t t-esc="props.data.date"/></div>
                </div>

                <!-- CUSTOMER INFO -->
                <div t-if="props.data.customer" t-log="props.data.customer3" class="receipt-section border-bottom border-dark">
                    <div t-if="props.data.customer.name" class="mb-1 small">
                        <strong>Name: <t t-esc="props.data.customer.name"/></strong>
                    </div>
                    <div t-if="props.data.customer.street or props.data.customer.street2 or props.data.customer.city or props.data.customer.state_id or props.data.customer.zip or props.data.customer.country_id" class="small">
                        <div class="fw-bold">Address:</div>
                        <div t-if="props.data.customer.street" style="margin-left: 10px;">
                            <t t-esc="props.data.customer.street"/>
                        </div>
                        <div t-if="props.data.customer.street2" style="margin-left: 10px;">
                            <t t-esc="props.data.customer.street2"/>
                        </div>
                        <div t-if="props.data.customer.city or props.data.customer.state_id or props.data.customer.zip" style="margin-left: 10px;">
                            <t t-if="props.data.customer.city" t-esc="props.data.customer.city"/>
                            <t t-if="props.data.customer.city and props.data.customer.state_id">, </t>
                            <t t-if="props.data.customer.state_id" t-esc="props.data.customer.state_id"/>
                            <t t-if="(props.data.customer.city or props.data.customer.state_id) and props.data.customer.zip"> </t>
                            <t t-if="props.data.customer.zip" t-esc="props.data.customer.zip"/>
                        </div>
                        <div t-if="props.data.customer.country_id" style="margin-left: 10px;">
                            <t t-esc="props.data.customer.country_id"/>
                        </div>
                    </div>
                    <div t-if="props.data.customer.phone" class="small">
                        <strong>Phone:</strong> <t t-esc="props.data.customer.phone"/>
                    </div>
                    <div t-if="props.data.customer.email" class="small">
                        <strong>Email:</strong> <t t-esc="props.data.customer.email"/>
                    </div>
                </div>

                <!-- ITEMS TABLE -->
                <div t-if="props.data.orderlines?.length" class="receipt-section">
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless mb-0" style="table-layout: fixed;">
                            <thead>
                                <tr class="border-bottom border-dark">
                                    <th class="text-start ps-0" style="width: 40%;">Item</th>
                                    <th class="text-center" style="width: 15%;">Qty</th>
                                    <th class="text-end" style="width: 20%;">Rate</th>
                                    <th class="text-end pe-0" style="width: 25%;">Amount</th>
                                </tr>
                            </thead>
                            <!-- Items -->
                            <tbody>
                                <tr t-foreach="props.data.orderlines" t-as="line" t-key="line_index">
                                    <td class="align-top ps-0" style="width: 40%; word-break: break-all;">
                                        <div>
                                            <t t-if="line.categoryNameAr and !line.isDiscountProduct" t-esc="line.categoryNameAr + ' - '"/>
                                            <t t-esc="line.productName"/>
                                        </div>
                                        <div t-if="line.discount and line.discount !== '0' and !line.productName.toLowerCase().includes('discount')" class="small text-muted fst-italic">
                                            Discount: <t t-esc="line.discount"/>%
                                        </div>
                                        <div t-if="line.customerNote" class="small text-muted fst-italic">
                                            Note: <t t-esc="line.customerNote"/>
                                        </div>
                                    </td>
                                    <td class="text-center align-top">
                                        <t t-set="qtyStr" t-value="line.qty.toString()"/>
                                        <t t-set="qtyWhole" t-value="qtyStr.includes('.') ? qtyStr.split('.')[0] : qtyStr"/>
                                        <div t-esc="qtyWhole"/>
                                        <div class="small text-muted" t-esc="convertToArabicNumeralsOnly(qtyWhole)"/>
                                    </td>
                                    <td class="text-end align-top">
                                        <t t-set="unitPriceStr" t-value="line.unitPrice.split(' ')[0]"/>
                                        <t t-set="unitPriceParts" t-value="unitPriceStr.split('.')"/>
                                        <t t-set="unitPriceFormatted" t-value="unitPriceParts[0] + '.' + (unitPriceParts[1] || '00').substring(0, 2).padEnd(2, '0')"/>
                                        <div t-esc="unitPriceFormatted"/>
                                        <div class="small text-muted" t-esc="convertToArabicNumeralsOnly(unitPriceFormatted)"/>
                                    </td>
                                    <td class="text-end align-top pe-0" style="width: 25%;">
                                        <t t-set="priceStr" t-value="line.price.split(' ')[0]"/>
                                        <t t-set="priceParts" t-value="priceStr.split('.')"/>
                                        <t t-set="priceFormatted" t-value="priceParts[0] + '.' + (priceParts[1] || '00').substring(0, 2).padEnd(2, '0')"/>
                                        <div t-esc="priceFormatted"/>
                                        <div class="small text-muted" t-esc="convertToArabicNumeralsOnly(priceFormatted)"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TOTAL -->
                <div class="receipt-section border-top border-dark">
                    <div class="d-flex justify-content-between">
                        <strong>
                            <t t-out="props.data.label_total or 'Total:'"/>
                        </strong>
                        <strong>
                            <t t-set="taxTotals" t-value="props.data.taxTotals"/>
                            <t t-if="taxTotals" t-esc="formatCurrency(taxTotals.order_sign * taxTotals.order_total)"/>
                            <t t-else="" t-esc="formatCurrency(props.data.total_with_tax)"/>
                        </strong>
                    </div>
                </div>

                <!-- PAYMENTS -->
                <div t-if="props.data.paymentlines?.length" class="receipt-section border-top border-dark pt-1">
                    <div t-foreach="props.data.paymentlines" t-as="line" t-key="line_index" class="d-flex justify-content-between">
                        <span t-esc="line.name"/>
                        <span t-esc="formatCurrency(line.amount)"/>
                    </div>

                    <div t-if="props.data.show_change" class="d-flex justify-content-between small">
                        <span t-out="props.data.label_change"/>
                        <span t-esc="formatCurrency(props.data.order_change)"/>
                    </div>

                    <div t-if="props.data.total_discount" class="d-flex justify-content-between">
                        <span t-out="props.data.label_discounts"/>
                        <span t-esc="formatCurrency(props.data.total_discount)"/>
                    </div>
                </div>

                <!-- GENERAL NOTE -->
                <div t-if="props.data.generalNote" class="receipt-section border-top border-dark pt-1 fw-bold">
                    <div style="white-space: pre-line;" t-esc="props.data.generalNote"/>
                </div>

                <!-- QR CODE -->
                <div class="receipt-section text-center">
                    <img src="/pos_kuwait_retail/static/src/img/brand_qr_code.png"
                         alt="Brand QR Code"
                         style="width: 100px; height: 100px;"/>
                    <div class="mt-1">Scan to visit our brand page</div>
                </div>

                <!-- FOOTER -->
                <div t-if="props.data.footer" class="receipt-section text-center" style="white-space: pre-line;" t-esc="props.data.footer"/>

                <!-- Payment Terminal Receipts (hidden) -->
                <div class="d-none">
                    <t t-foreach="props.data.paymentlines" t-as="line" t-key="line_index">
                        <div t-if="line.ticket" class="pos-payment-terminal-receipt">
                            <pre t-esc="line.ticket"/>
                        </div>
                    </t>
                </div>
            </div>
        </xpath>
    </t>
</templates>